<!DOCTYPE html>
<html lang="en">
<head>
  <title>PokÃ©monJS</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no">
  <meta property="og:title" content="PBA" />
  <meta property="og:description" content="Simple Pokemon Battle Game ." />
  <link href="/favicon.ico" rel="icon" type="image/x-icon" />
  <link href="/tailwind.min.css" rel="stylesheet" />
  <link href="/custom.css" rel="stylesheet" />
  <link href="/styles.css" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body class="bg-blue-200">
  <!-- Floating chat button -->
  <button id="openChatBtn" class="floating-btn">ðŸ’¬</button>

  <!-- Modal for displaying chat -->
  <div id="chatModal" class="modal">
    <div class="modal-content">
      <span id="closeChatBtn" class="close">&times;</span>
      <div id="chatContainer" class="p-4">
        <!-- Chat messages will be dynamically added here -->
      </div>
      <input type="text" id="messageInput" placeholder="Type your message..." class="p-2 border border-gray-300 rounded">
      <button id="sendBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Send</button>
      <button id="changeNameBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Change Name</button>
    </div>
  </div>

  <script>
    // Function to get the chatroom ID from the URL
    function getChatroomId() {
      const url = window.location.href;
      const match = url.match(/\/battle\/(\d+)/);
      return match ? match[1] : 'PBA125';
    }

    // Function to get or prompt for the user's name
    function getUserName() {
      let userName = localStorage.getItem('userName');
      if (!userName) {
        userName = prompt("Please enter your name:");
        if (userName) {
          localStorage.setItem('userName', userName);
        } else {
          userName = 'Guest';
        }
      }
      return userName;
    }

    // Function to change the user's name
    function changeUserName() {
      const newUserName = prompt("Enter new name:");
      if (newUserName) {
        localStorage.setItem('userName', newUserName);
        alert('Name changed successfully.');
      }
    }

    // Function to fetch chat messages from the API
    async function fetchChatMessages(roomId) {
      try {
        const response = await fetch(`http://158.101.198.227:8534/api/inbox/${roomId}`);
        if (!response.ok) {
          throw new Error('Chat room not found');
        }
        const data = await response.json();
        return data.messages;
      } catch (error) {
        console.error('Error fetching chat messages:', error);
        return [];
      }
    }

    // Function to send a message via API
    async function sendMessage(roomId, username, message) {
      try {
        const response = await fetch(`http://158.101.198.227:8534/api/message?chatroom_id=${roomId}&username=${username}&message=${encodeURIComponent(message)}`, {
          method: 'POST'
        });
        if (!response.ok) {
          throw new Error('Failed to send message');
        }
        return true;
      } catch (error) {
        console.error('Error sending message:', error);
        return false;
      }
    }

    // Function to render chat messages in the modal
    async function renderChatModal(roomId) {
      const chatContainer = document.getElementById('chatContainer');
      const messages = await fetchChatMessages(roomId);
      
      // Clear existing messages
      chatContainer.innerHTML = '';

      // Render each message
      messages.forEach(message => {
        const messageElement = document.createElement('div');
        messageElement.classList.add('mb-2', 'p-2', 'rounded', 'bg-white', 'shadow');
        messageElement.innerHTML = `
          <strong>${message.username}:</strong> ${message.message}
        `;
        chatContainer.appendChild(messageElement);
      });
    }

    // Call renderChatModal when DOM content is loaded
    document.addEventListener("DOMContentLoaded", function() {
      const openChatBtn = document.getElementById('openChatBtn');
      const closeChatBtn = document.getElementById('closeChatBtn');
      const chatModal = document.getElementById('chatModal');
      const sendBtn = document.getElementById('sendBtn');
      const changeNameBtn = document.getElementById('changeNameBtn');
      const messageInput = document.getElementById('messageInput');
      const chatContainer = document.getElementById('chatContainer');

      const currentRoomId = getChatroomId(); // Get room ID from URL or default
      let username = getUserName(); // Get username from local storage or prompt

      // Open chat modal
      openChatBtn.addEventListener('click', async () => {
        await renderChatModal(currentRoomId);
        chatModal.style.display = "block";
      });

      // Close chat modal
      closeChatBtn.addEventListener('click', () => {
        chatModal.style.display = "none";
      });

      // Send message
      sendBtn.addEventListener('click', async () => {
        const message = messageInput.value.trim();
        
        if (message !== '') {
          const success = await sendMessage(currentRoomId, username, message);
          if (success) {
            // Add the sent message to the UI
            const messageElement = document.createElement('div');
            messageElement.classList.add('mb-2', 'p-2', 'rounded', 'bg-white', 'shadow');
            messageElement.innerHTML = `
              <strong>${username}:</strong> ${message}
            `;
            chatContainer.appendChild(messageElement);
            messageInput.value = ''; // Clear input field
          } else {
            alert('Failed to send message. Please try again.');
          }
        }
      });

      // Change username
      changeNameBtn.addEventListener('click', () => {
        changeUserName();
        username = getUserName(); // Update username after change
      });
    });
  </script>
  <script src="/bundle.js"></script>

</body>
</html>
